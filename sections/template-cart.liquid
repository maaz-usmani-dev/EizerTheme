{% if cart.item_count > 0 %}
  <div class="p-4" id="cart-wrapper">
    <div class="max-w-6xl flex flex-col mx-auto my-10">
      <div class="flex items-end justify-between my-5">
        <h1 class="text-3xl">Your Cart</h1>
        <a
          href="{{routes.all_products_collection_url}}"
          class="text-blue-500 hover:text-blue-700 font-medium underline"
          >Continue Shopping</a
        >
      </div>
    </div>
    <div class="max-w-6xl flex flex-col my-10 mx-auto">
      <form action="{{routes.cart_url}}" method="post" novalidate>
        <table class="table-auto divide-y divide-gray-300 my-4 w-full">
          <thead>
            <tr>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Product</th>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Price</th>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Quantity</th>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Total Price</th>
            </tr>
          </thead>
          <tbody id="cart-items">
            {% for item in cart.items %}
              <tr class="table-row cart-item" data-key="{{item.key}}">
                <td class="py-4 px-2 flex flex-col justify-center">
                  <a href="{{item.url}}">
                    {% if item.image %}
                      <img
                        src="{{item.image | image_url: width: '200' }}"
                        alt="{{item.image.alt}}"
                        class="w-20 h-20 object-cover border"
                        width=""
                        height=""
                      >
                    {% else %}
                      {{ 'product-1' | placeholder_svg_tag: 'w-20 h-20 object-cover border ' }}
                    {% endif %}
                  </a>
                </td>
                <td class="py-4 px-2 flex flex-col justify-center">
                  <a href="{{item.url}}" class="my-1">{{ item.product.title | truncatewords: 5 }}</a>
                  <span class="text-sm text-gray-500 my-1">
                    {{ item.variant.title }}
                  </span>
                  <a
                    href="javascript:void(0)"
                    class="text-sm font-medium text-red-500 my-1 remove-item"
                    data-key="{{item.key}}"
                  >
                    Remove
                  </a>
                </td>
                <td class="py-4 px-2">
                  {{ item.price | money }}
                </td>
                <td class="py-4 px-2">
                  <input
                    type="number"
                    name="updates[]"
                    value="{{item.quantity}}"
                    class="w-20 border p-2 cart-qty"
                    min="1"
                    id="updates_{{forloop.index}}"
                    data-key="{{ item.key }}"
                    data-price="{{ item.final_line_price | divided_by: item.quantity }}"
                  >
                </td>
                <td class="py-4 px-2 line-total">
                  {{ item.final_line_price | money }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="flex flex-col md:flex-row items-center justify-between">
          <div class="w-full my-4">
            <div class="flex flex-col items-start">
              <label for="cart_notes" class="my-1">Cart Notes</label>
              <textarea name="note" id="cart_notes" class="w-full md:max-w-lg resize-none border h-20"></textarea>
            </div>
          </div>
          <div class="w-full my-4 md:w-80">
            <h3 class="text-xl" id="cart-Total">{{ cart.total_price | money }}</h3>
            <div class="my-2">
              <button
                type="submit"
                name="update"
                class="w-full p-3 border border-lime-500 bg-white text-lime-500 font-medium hover:bg-lime-500 hover:text-white hover:border-white"
              >
                Update
              </button>
            </div>
            <div class="my-2">
              <button
                type="submit"
                name="checkout"
                class="w-full p-3 border border-lime-600 font-medium bg-lime-500 text-white"
              >
                Checkout
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
{% else %}
  <div class="max-w-6xl h-60 flex items-center justify-center my-4 mx-auto" id="cart-wrapper">
    <div class="text-center">
      <h1 class="text-3xl my-4">Your Cart is Empty</h1>
      <div class="my-4 py-4">
        <a
          href="{{routes.all_products_collection_url}}"
          class="border border-white bg-lime-500 text-white hover:bg-white hover:text-lime-500 hover:border-lime-500 text-center px-8 py-4 rounded-xl"
          >Continue Shopping</a
        >
      </div>
    </div>
  </div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cartWrapper = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-Total');
    const container = document.getElementById('cart-wrapper');
    const cartCountEl = document.getElementById('cartCount');
    const emptyCartHtml = `
        <div class="max-w-6xl h-60 flex items-center justify-center my-4 mx-auto">
          <div class="text-center">
            <h1 class="text-3xl my-4">Your Cart is Empty</h1>
            <div class="my-4 py-4">
              <a href="/collections/all"
                class="border border-white bg-lime-500 text-white hover:bg-white hover:text-lime-500 hover:border-lime-500 text-center px-8 py-4 rounded-xl">
                Continue Shopping
              </a>
            </div>
          </div>
        </div>`;

    function formatMoney(cents) {
      const amount = (cents / 100).toLocaleString('en-PK', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return `Rs. ${amount}`;
    }

    // Quantity Update
    document.querySelectorAll('input[type="number"][data-key]').forEach((input) => {
      input.addEventListener('change', () => {
        const key = input.dataset.key;
        const quantity = parseInt(input.value);
        fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: quantity }),
        })
          .then((res) => res.json())
          .then((cart) => {
            const line = input.closest('tr');
            const price = parseFloat(input.dataset.price);
            const lineTotalCell = line.querySelector('.line-total');
            lineTotalCell.textContent = formatMoney(price * quantity);
            cartTotal.textContent = formatMoney(cart.total_price);
            if (cartCountEl) cartCountEl.textContent = cart.item_count;
          });
      });
    });

    // Item Removal
    document.querySelectorAll('.remove-item').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const key = btn.dataset.key;
        fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: 0 }),
        })
          .then((res) => res.json())
          .then((cart) => {
            btn.closest('tr').remove();
            if (cart.items.length === 0) {
              container.innerHTML = emptyCartHtml;
              if (cartCountEl) cartCountEl.textContent = '';
            } else {
              cartTotal.textContent = formatMoney(cart.total_price);
              if (cartCountEl) cartCountEl.textContent = cart.item_count;
            }
          });
      });
    });
  });
</script>